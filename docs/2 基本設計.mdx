---
slug: design
title: 基本設計書
---

## 予約システム 基本設計書

## 1. システム概要

本システムは、顧客、店舗スタッフ、および管理者のためのオンライン予約管理プラットフォームである。顧客はWebサイトを通じて直感的な操作でサービスの予約を行える。一方、店舗側は予約状況、スタッフのスケジュール、顧客情報、提供メニューなどを一元的に管理することが可能となる。

主な機能は以下の通りである。
- **顧客向け機能**: サービスメニューの閲覧、スタッフ指名、日時選択、予約内容の確認・完了、予約履歴の確認。
- **スタッフ向け機能**: 自身の予約タイムテーブルの確認、担当予約の管理、勤務スケジュールの設定。
- **管理者向け機能**: 全予約の管理、顧客情報管理、店舗設定（営業時間、スタッフ、メニュー等）の編集、売上や予約数の分析。

本ドキュメントは、これらの機能を実現するための技術的な設計と実装方針を定義するものである。

## 2. 技術スタック

本システムは、Next.js (App Router) を中心としたモダンなWeb技術スタックで構築する。リアルタイム性とサーバーレスの利点を活かすため、バックエンドにはConvexを採用する。

- **フロントエンド**: Next.js 15 (React 19), TypeScript
  - レンダリング方針:
    - React Server Components (RSC) を基本とし、ページ全体の初期データ取得・描画をサーバー側で行う。
    - インタラクティブ性が求められる予約フロー（カレンダー、メニュー選択、スタッフ指名など）やUI部品（モーダル、ドロップダウン等）は Client Components として実装する。
    - このハイブリッド戦略により、初期表示の高速化と動的操作性の両立を実現する。
- **バックエンド**:
  - **Convex**: リアルタイムデータベースと主要なサーバーレス機能。データの変更が即座にフロントエンドに反映される。
  - **Next.js (Route Handlers)**: Webhookの受け口や、Convexでは実装しにくい特定のAPIエンドポイントのために補助的に使用。
- **状態管理**:
  - **Jotai**: クライアントサイドのシンプルなグローバル状態管理に使用。
  - **TanStack Query**: サーバー状態の管理（データのフェッチ、キャッシュ、更新）に使用し、UIの応答性とデータの一貫性を担保する。
- **認証**: NextAuth.js
  - GoogleなどのOAuthプロバイダによる認証を容易に実装するために採用。
  - 認証情報はConvexのデータベースと連携させる。
- **スタイリング**: Tailwind CSS v4, shadcn/ui
  - ユーティリティファーストのアプローチで効率的にUIを構築する。
  - shadcn/uiをベースとした再利用可能なコンポーネント群を利用する。

## 3. 主要機能の設計

### 3.1. 認証フロー

本システムは、外部の認証プロバイダ（Googleなど）を利用したOAuth認証を基本とする。

1.  ユーザーが「Googleでログイン」などのボタンをクリックすると、認証プロバイダの認証画面に遷移する。
2.  認証が成功すると、システムはユーザー情報を取得する。
3.  システム内のデータベースにユーザー情報が存在するかを確認し、存在しない場合は新規に登録する。
4.  以降、ユーザーは認証された状態でシステムの機能を利用できる。

### 3.2. 予約フロー

顧客による予約プロセスは、以下のステップに分かれたウィザード形式で実現する。各ステップで選択された情報は、フローの最後まで維持される。

1.  **メニュー選択** (`/customer/reservation/menu`)
2.  **スタッフ選択** (`/customer/reservation/staff`)
3.  **日時選択** (`/customer/reservation/datetime`)
4.  **予約内容確認** (`/customer/reservation/confirm`)
5.  **予約完了** (`/customer/reservation/complete`)

### 3.3. 前回の予約内容の再利用

リピート顧客の予約体験を向上させるため、前回の予約内容を再利用する機能を実装する。

**対象ユーザー**:
ログイン済みで、かつ過去に1回以上の予約履歴がある顧客。

**機能フロー**:

1.  顧客が予約フローを開始する際、システムは過去の予約履歴の有無を確認する。
2.  最新の予約履歴が存在する場合、前回の予約内容（メニュー、スタッフ等）を再利用して予約を進めるかを選択肢として提示する。
3.  ユーザーが「再利用する」を選択した場合、メニューとスタッフの選択ステップをスキップし、日時選択画面へ直接遷移する。
4.  ユーザーが「再利用しない」を選択した場合、または過去の予約が存在しない場合は、通常の予約フロー通りメニュー選択から開始する。

この機能により、顧客は毎回同じメニューやスタッフを選択する手間を省き、より迅速に予約を完了できるようになる。

## 4. 画面設計

本システムの画面設計は、ユーザーが直感的かつ快適に操作できることを最優先とする。

### 4.1. レイアウト

アプリケーションの主要なレイアウトは、全ページで一貫性を保つため、以下の3つの主要な要素で構成される。

- **ヘッダー**:
  - 全ページ共通で表示される上部エリア。
  - アプリケーションのロゴ、ナビゲーション用のメニュー開閉ボタン（モバイル時）、ユーザー関連の表示（ログイン状態など）が含まれる。
- **サイドバー**:
  - 主要機能へアクセスするためのナビゲーションメニュー。
  - デスクトップでは常時表示され、モバイルでは必要に応じて開閉する。
- **コンテンツエリア**:
  - 各ページのメインコンテンツが表示される中心的な領域。

### 4.2. レスポンシブデザイン

- **モバイルファースト**: まずモバイルデバイスでの最適な表示を設計し、その後タブレット、デスクトップへと段階的にレイアウトを調整する（ブレークポイントはTailwind CSSのデフォルト設定に準拠）。
- 画面サイズに応じてコンポーネントの表示を動的に切り替えることで、各デバイスに最適化されたUIを提供する。

### 4.3. 画面一覧

- **トップページ**: `/`
  - アプリケーションのランディングページ。
- **顧客向けトップページ**: `/customer`
  - 顧客が予約を開始したり、情報を確認したりする起点となるページ。
- **予約フロー**:
  - **メニュー選択**: `/customer/reservation/menu`
  - **スタッフ選択**: `/customer/reservation/staff`
  - **日時選択**: `/customer/reservation/datetime`
  - **予約内容確認**: `/customer/reservation/confirm`
  - **予約完了**: `/customer/reservation/complete`
- **管理者向けトップページ**: `/admin`
  - 管理者が予約状況や店舗情報を管理するダッシュボード。
- **スタッフ向けページ**:
  - **ログインページ**: `/staff/login` (認証機能によりNextAuth.jsが提供するページを利用)
  - **ダッシュボード**: `/staff/dashboard` (本日の予約一覧、新規予約・キャンセル通知など)
  - **予約管理**: `/staff/reservations` (予約のタイムテーブル表示、詳細確認、新規登録・編集・キャンセル)
  - **スケジュール管理**: `/staff/schedule` (自身の出勤・退勤時刻、休憩時間、休日設定)
- **管理者向けページ**:
  - **ログインページ**: `/admin/login` (認証機能によりNextAuth.jsが提供するページを利用)
  - **ダッシュボード**: `/admin/dashboard` (スタッフ向け機能に加え、売上レポート、予約数、キャンセル率の分析など)
  - **予約管理**: `/admin/reservations` (スタッフ向けと同様の機能)
  - **顧客管理**: `/admin/customers` (顧客情報の登録・検索・編集)
  - **店舗設定**: `/admin/settings` (店舗の基本情報、営業日・時間、スタッフ情報、施術メニューの登録・編集)
- **開発用ページ**:
  - **デバッグページ**: `/(dev)/debug`
  - **プレースホルダー画像**: `/(dev)/placeholder-image`
  - **サンプルページ**: `/(dev)/sample`
  - **ドキュメント一覧**: `/docs`
    - 各種ドキュメントへのリンクを一覧表示するページ。
  - **個別ドキュメントページ**: `/docs/[slug]`
    - 各ドキュメントの内容を表示するページ。

## 5. データベース設計

データベースはConvexを使用し、スキーマは`convex/schema.ts`で定義する。以下は主要なテーブル（コレクション）の設計概要である。

- **`stores`**: 店舗情報
  - 店舗の基本情報を格納する。
  - `name`: 店舗名 (String)
  - `address`: 住所 (String)
  - `phone`: 電話番号 (String)
  - `openingHours`: 曜日ごとの営業時間 (Array of Objects)
  - `specialHolidays`: 特定の休業日 (Array of Strings, Optional)

- **`users`**: 全ユーザー情報
  - 顧客、スタッフ、管理者の共通情報を格納し、NextAuth.jsと連携する。
  - `name`: ユーザー名 (String, Optional)
  - `email`: メールアドレス (String)
  - `image`: プロフィール画像URL (String, Optional)
  - `tokenIdentifier`: NextAuth.js連携用の識別子 (String)
  - `role`: ユーザー権限 (`customer`, `staff`, `admin`)
  - `storeId`: 所属店舗ID (ID, Optional)

- **`staffs`**: スタッフ詳細情報
  - `users`テーブルと1対1で関連付けられるスタッフ固有情報。
  - `userId`: 関連する`users`のID (ID)
  - `storeId`: 所属店舗ID (ID)
  - `title`: 役職 (String, Optional)
  - `bio`: 自己紹介 (String, Optional)
  - `imageUrl`: プロフィール画像URL (String, Optional)
  - `storageId`: 画像ストレージID (ID, Optional)

- **`services`**: 施術メニュー
  - 店舗が提供するサービスの詳細。
  - `storeId`: 提供店舗ID (ID)
  - `name`: メニュー名 (String)
  - `description`: 詳細説明 (String)
  - `price`: 価格 (Number)
  - `duration`: 所要時間（分） (Number)
  - `category`: カテゴリ (String)
  - `isActive`: 提供中かどうかのフラグ (Boolean)
  - `imageUrl`: メニュー画像URL (String, Optional)
  - `storageId`: 画像ストレージID (ID, Optional)

- **`reservations`**: 予約情報
  - 予約イベントの中心的な情報を格納する。
  - `customerId`: 顧客の`users`ID (ID)
  - `staffId`: 担当`staffs`ID (ID)
  - `serviceId`: `services`ID (ID)
  - `storeId`: 店舗ID (ID)
  - `dateTime`: 予約日時 (Number, Unix Timestamp)
  - `status`: 予約ステータス (`pending`, `confirmed`, `cancelled`, `completed`)
  - `totalPrice`: 予約時点の合計料金 (Number)
  - `totalDuration`: 予約時点の合計所要時間 (Number)
  - `notes`: 顧客からのメモ (String, Optional)

- **`schedules`**: 勤務スケジュール
  - スタッフの基本的な勤務パターンと、例外日（特別休業日・出勤日）を管理する。
  - `staffId`: `staffs`ID (ID)
  - `workingHours`: 曜日ごとの基本勤務時間 (Array of Objects)
  - `specialHolidays`: 特定の休業日 (Array of Strings, Optional)
  - `specialWorkdays`: 特定の出勤日と勤務時間 (Array of Objects, Optional)

